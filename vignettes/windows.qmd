---
title: "Windows Builds"
format:
  html:
    code-fold: true
editor: visual
engine: knitr
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

Let's get info about all windows builds.

## Install dependencies and set larger max

```{r library, eval = "hide", message = FALSE}

library(universe)
library(BiocPkgTools)
library(dplyr)
library(DT)
library(tibble)

# set max.print to get all packages
options(max.print = 3000L)

r_xy_ver <- function(x) {
    xyz <- strsplit(x[[1]], "\\.")
    paste(xyz[[1]][1], xyz[[1]][2], sep=".")
}

#' Generates the URL to retrieve the snapshot of a universe
#'
#' uni character name of the universe
#' r_versions character R versions
#' oses character comma separated string of oses without spaces; any combination 
#'     of src,win,mac,linux,wasm,docs
#' pkgs character a string of comma-separated package names without spaces or a
#'     character vector of package names
make_snapshot_url <- function(uni, r_versions = NULL, oses = NULL, pkgs = NULL) {
    suffix <- ""

    if (!is.null(oses)) {
        suffix <- ifelse(suffix == "", paste0("zip?types=", oses),
                         paste0(suffix, "&types=", oses))
    }

    if (!is.null(r_versions)) {
        versions <- sapply(strsplit(r_versions, ",[ ]*")[[1]], r_xy_ver) |>
            unname() |>
            paste(collapse = ",")
        suffix <- ifelse(suffix == "",
                         paste0("zip?binaries=", versions),
                         paste0(suffix, "&binaries=", versions))
    }
    if (!is.null(pkgs)) {
        if (length(pkgs) > 1)
            pkgs <- paste0(pkgs, collapse = ",")
        suffix <- paste0(suffix, "&packages=", pkgs, collapse="")
    }
    paste0("https://", uni, ".r-universe.dev/api/snapshot/", suffix)
}

uni_pkg_file <- function(pkg, os, bin_ver) {
    if (os == "windows")
        ext <- "zip"
    else if (os == "macosx")
        ext <- "tgz"
    else
        ext <- "tar.gz"
    paste0(pkg, "_", bin_ver, ".", ext)
}

uni_repo_url <- function(uni, os, r_version) {
    if (os == "macosx")
        repo_path <- paste(c("bin", os, "big-sur-x86_64"), collapse = "/")
    else if (os == "windows")
        repo_path <- paste(c("bin", os), collapse = "/")
    else
        repo_path <- "src"
    root <- paste0("https://", uni, ".r-universe.dev")
    paste(c(root, repo_path, "contrib", r_xy_ver(r_version), ""), collapse = "/")
}

get_binary_os <- function(os) {
    if (os %in% c("windows", "macos"))
        os <- substr(os, 1, 3)
    os
}

get_uni_pkgs <- function(uni, uni_branch, r_version, os, bioc_version) {
    ru_info <- universe::universe_all_packages(uni, limit = 3000L)
    bbs_info <- BiocPkgTools::biocPkgList(version = bioc_version,
                                          repo="BioCsoft")

    builds <- data.frame(Package = "",
                         Version = "",
                         JobUrl = "",
                         JobCheck = "",
                         BinariesCheck = "",
                         BinariesUrl = "",
                         BinariesBuildDate = "",
                         BinariesStatus = "",
                         RU_commit = "",
                         BBS_commit = "",
                         MD5sum = "",
                         RemoteSha = "",
                         RemoteUrl = "",
                         Published = "",
                         File = "")

    uni_repo <- uni_repo_url(uni, os, r_version)

    for (i in seq_along(ru_info)) {
      jobid <- ""
      jobcheck <- ""
      binaries_buildurl <- ""
      binaries_status <- ""
      binaries_check <- ""
      binaries_builddate <- ""
      binaries_version <- ""
      
      for (j in seq_along(ru_info[[i]]$`_jobs`)) {
        job <- ru_info[[i]]$`_jobs`[[j]]
        if (job$config == paste(os, uni_branch, sep = "-") && job$r == r_version) {
          jobid <- as.character(job$job)
          jobcheck <- job$check
          break
        }
      }
      
      for (k in seq_along(ru_info[[i]]$`_binaries`)) {
        binary <- ru_info[[i]]$`_binaries`[[k]]
        if (binary$os == get_binary_os(os) && binary$r == r_version) {
          ru_commit <- as.character(binary$commit)
          binaries_buildurl <- binary$buildurl
          binaries_status <- binary$status
          binaries_check <- binary$check
          binaries_builddate <- binary$date
          binaries_version <- binary$version
          break
        }
      }
      
      if (is.null(ru_commit))
          ru_commit <- ""
      
      bbs_commit <- bbs_info |>
        dplyr::filter(Package == ru_info[[i]]$Package) |>
        dplyr::pull(git_last_commit)

      pkg_file <- uni_pkg_file(ru_info[[i]]$Package, os, binaries_version)
      link <- paste0("<a href='", paste0(uni_repo, pkg_file), "'>",
                     pkg_file, "</a>")
      builds <- tibble::add_row(builds,
                                Package = ru_info[[i]]$Package,
                                Version = ru_info[[i]]$Version,
                                JobUrl = ifelse(!is.null(ru_info[[i]]$`_buildurl`),
                                                paste0("<a href='",
                                                       ru_info[[i]]$`_buildurl`, "/job/",
                                                       jobid, "'>", jobcheck,
                                                       "</a>"),
                                                ""),
                                JobCheck = jobcheck,
                                BinariesCheck = binaries_check,
                                BinariesUrl = ifelse(binaries_status == "success",
                                                     paste0("<a href='",
                                                            binaries_buildurl,
                                                            "'>", binaries_check,
                                                            "</a>"),
                                                     paste0("<a href='",
                                                            binaries_buildurl,
                                                            "'>", binaries_status,
                                                            "</a>")),
                                RU_commit = substr(ru_commit, 1, 7),
                                BBS_commit = bbs_commit,
                                MD5sum = substr(ru_info[[i]]$MD5sum, 1, 7),
                                RemoteSha = substr(ru_info[[i]]$RemoteSha, 1, 7),
                                RemoteUrl = ru_info[[i]]$RemoteUrl,
                                Published = ru_info[[i]]$`_published`,
                                BinariesBuildDate = binaries_builddate,
                                BinariesStatus = binaries_status,
                                File = ifelse(ru_commit != "", link, ""))
    }
    
    # drop blank first row
    builds <- builds[c(-1), ]
    
    builds |>
      dplyr::arrange(Package)
}
```

## Windows Results from bioc.r-universe.dev

```{r devel-windows-results, message = FALSE}
uni_devel_pkgs <- get_uni_pkgs("bioc", "devel", "4.6.0", "windows", "3.23")

devel_uni_pkgs <- dplyr::rename(uni_devel_pkgs, "Latest Check" = JobUrl,
                                "Binary Check" = BinariesUrl) |>
      dplyr::select(Package, Version, "Latest Check", "Binary Check",
                    BinariesBuildDate, RU_commit, BBS_commit, File)

DT::datatable(devel_uni_pkgs, escape = FALSE)
```

## Passing packages with the same commit hash as in BBS

The following packages have the same commit hash in R-Universe and the BBS. They
also pass the latest `R CMD check` and their binary also passes `R CMD check`
with a value of `NOTE`, `WARNING`, or `OK`.

```{r devel-passing-with-same-commit, message = FALSE}

viable_devel_candidates <- uni_devel_pkgs |>
    dplyr::filter(BBS_commit == RU_commit, 
                  BinariesCheck %in% c("NOTE", "WARNING", "OK"),
                  JobCheck %in% c("NOTE", "WARNING", "OK"),
                  BinariesStatus == "success") |>
    dplyr::rename("Latest Check" = JobUrl, "Binary Check" = BinariesUrl) |>
    dplyr::select(Package, Version, "Latest Check", "Binary Check",
                  BinariesBuildDate, RU_commit, BBS_commit, Published, File)

DT::datatable(viable_devel_candidates, escape = FALSE)
```

## Download a snapshot of passing packages with the same commit hash in the BBS

```{r devel-download-repo-for-passing-packages}
make_snapshot_url("bioc", "4.6", "win", viable_devel_candidates$Package)
```

## Packages failing on Windows

The following packages are failing on Windows.

```{r devel-win-errors, message = FALSE}

failing_windows <- uni_devel_pkgs |>
    dplyr::filter(JobCheck == "ERROR" | BinariesCheck == "ERROR",
                  BinariesStatus != "success") |>
    dplyr::rename("Latest Check" = JobUrl, "Binary Check" = BinariesUrl) |>
    dplyr::select(Package, Version, "Latest Check", "Binary Check",
                  BinariesBuildDate, RU_commit, BBS_commit, File)

DT::datatable(failing_windows, escape = FALSE)
```

### Understanding the error

For more details about the error, click on the link. The `Latest Check` will go
to the latest GitHub Action Workflow run's `R CMD check` on the package whereas
the `Binary Check` will go to the GitHub Action Workflow associated with the
`R CMD check` associated with the binary. It may not take you to the specific
location of the error. You need to look at the `Build R-release for Windows`
(on left), which builds the same package version as Bioconductor devel for the
correct version of R. You can then either expand the `Annotations` or expand
`R CMD check` to see more details about the error. You must be logged in to see
more details.

![annotations](images/annotations.png)

![r_cmd_check](images/r_cmd_check.png)


```{r release-windows-results, message = FALSE, eval = FALSE}
# Failing due to stale branch
uni_release_pkgs <- get_uni_pkgs("bioconductor-source", "release", "4.5.2", "windows", "3.22")

release_uni_pkgs <- dplyr::rename(uni_release_pkgs, "Latest Check" = JobUrl,
                                  "Binary Check" = BinariesUrl) |>
      dplyr::select(Package, Version, "Latest Check", "Binary Check",
                    BinariesBuildDate, RU_commit, BBS_commit, File)

DT::datatable(release_uni_pkgs, escape = FALSE)
```

```{r release-passing-with-same-commit, message = FALSE, eval = FALSE}
# Failing due to stale branch
viable_release_candidates <- uni_release_pkgs |>
    dplyr::filter(BBS_commit == RU_commit, 
                  BinariesCheck %in% c("NOTE", "WARNING", "OK"),
                  JobCheck %in% c("NOTE", "WARNING", "OK"),
                  BinariesStatus == "success") |>
    dplyr::rename("Latest Check" = JobUrl, "Binary Check" = BinariesUrl) |>
    dplyr::select(Package, Version, "Latest Check", "Binary Check",
                  BinariesBuildDate, RU_commit, BBS_commit, Published, File)

DT::datatable(viable_release_candiates, escape = FALSE)
```

```{r release-download-repo-for-passing-packages, eval = FALSE}
# Failing due to stale branch
make_snapshot_url("bioc", "4.5", "win", viable_release_candiates$Package)
```

## sessionInfo()

```{r sessionInfo}
sessionInfo()
```
