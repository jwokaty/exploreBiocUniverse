---
title: "bioc.r-universe.dev windows devel"
format: html
editor: visual
engine: knitr
---

# Let's get info about all windows builds

## Install dependencies

```{r install_universe, eval = "hide", message = FALSE}
if (!require("universe", quietly = TRUE))
    install.packages("universe", repos = "https://ropensci.r-universe.dev")

library(universe)

# set max.print to get all packages
options(max.print = 3000L)

# We'll install BiocPkgTools so that we can check against build report info
BiocManager::install(c("BiocPkgTools", "dplyr"))

library(BiocPkgTools)
library(dplyr)
```

Get data for bioc.r-universe.dev and bbs devel

```{r all_bioc_ru}
devel <- "3.22"
ru_info <- universe::universe_all_packages("bioc", limit = 3000L)
bbs_info <- BiocPkgTools::biocPkgList(version = devel, repo="BioCsoft")
```

Are the same packages in bioc.r-universe.dev and 3.22 bbs?

```{r comparison}
ru_pkgs <- universe::universe_ls("bioc")
bbs_pkgs <- bbs_info$Package
only_ru <- c()
only_bbs <- c()

if (!identical(ru_pkgs, bbs_pkgs)) {
    only_ru <- setdiff(ru_pkgs, bbs_pkgs)
    only_bbs <- setdiff(bbs_pkgs, ru_pkgs)
    message("The two sets are not the same.")
    message("Only in bioc.r-universe.dev: ", paste0(only_ru, collapse = " "))
    message("Only in ", devel, " branch on the BBS: ",
            paste0(only_bbs, collapse = " "))
} else {
    message("The ", devel, " branch on the BBS and bioc.r-universe.dev have",
            "the same packages.")
}
```

For packages not in BBS

```{r only_ru}

only_ru_info <- data.frame(Package = only_ru,
                           RemoteUrl = "")

for (pkg in only_ru) {
    pkg_info <- universe::universe_one_package("bioc", pkg)
    only_ru_info[only_ru_info$Package == pkg, ]$RemoteUrl <- pkg_info$RemoteUrl
}

only_ru
```

If any of the above RemoteUrls are not from https://github.com/bioc then they
were added via https://github.com/r-universe/bioc/blob/master/.remotes.json.

We'll need to check why some packages aren't in bioc.r-universe.dev; however,
we already know `scafari` isn't there because it has files > 100MB in its
git history.

Next we want to get the data from all windows builds in bioc.r-universe.dev.

```{r find-all-windows-builds}
library(tibble)
r_version <- "4.5.1"

windows_builds <- data.frame(Package = "",
                             Version = "",
                             JobCheck = "",
                             BinariesCheck = "",
                             DatePublication = "",
                             Commit = "",
                             MD5sum = "",
                             RemoteSha = "",
                             RemoteUrl = "",
                             Published = "",
                             BinariesBuildDate = "",
                             JobId = "",
                             BuildUrl = "",
                             BinariesStatus = "")

for (i in seq_along(ru_info)) {
  jobid <- ""
  jobcheck <- ""
  commit <- ""
  buildurl <- ""
  binariesstatus <- ""
  buildcheck <- ""
  binariesbuilddate <- ""

  for (j in seq_along(ru_info[[i]]$`_jobs`)) {
      job <- ru_info[[i]]$`_jobs`[[j]]
      if (job$config == "windows-release" && job$r == r_version) {
          jobid <- as.character(job$job)
          jobcheck <- job$check
          break
      }
  }
  
  for (k in seq_along(ru_info[[i]]$`_binaries`)) {
      binary <- ru_info[[i]]$`_binaries`[[k]]
      if (binary$os == "win" && binary$r == r_version) {
          commit <- as.character(binary$commit)
          buildurl <- binary$buildurl
          binariesstatus <- binary$status
          buildcheck <- binary$check
          binariesbuilddate <- binary$date
          break
      }
  }
  windows_builds <- tibble::add_row(windows_builds,
                                    Package = ru_info[[i]]$Package,
                                    Version = ru_info[[i]]$Version,
                                    JobCheck = jobcheck,
                                    BinariesCheck = buildcheck,
                                    DatePublication = ru_info[[i]]$`Date/Publication`,
                                    Commit = commit,
                                    MD5sum = ru_info[[i]]$MD5sum,
                                    RemoteSha = ru_info[[i]]$RemoteSha,
                                    RemoteUrl = ru_info[[i]]$RemoteUrl,
                                    Published = ru_info[[i]]$`_published`,
                                    BinariesBuildDate = binariesbuilddate,
                                    JobId = jobid,
                                    BuildUrl = buildurl,
                                    BinariesStatus = binariesstatus)
#                                    Path = paste0(path, ru_info[[i]]$`_file`))
}

# drop blank first row
windows_builds <- windows_builds[c(-1), ]
```

We'll construct the path to the zip using the data associated with the win
`_binaries` information associated with our version of R.

```{r path-to-zip}
library(DT)

path <- "https://bioc.r-universe.dev/bin/windows/contrib/4.5/"

windows_builds <- windows_builds |>
    dplyr::mutate(File = ifelse(Commit != "", paste0(path, Package, "_", Version, ".zip"), "")) |>
    dplyr::arrange(Package)

DT::datatable(windows_builds)
```

```{r packages-without-windows-binaries}
missing_binaries <- windows_builds |>
    dplyr::filter(File == "") |>
    dplyr::select(Package)

missing_binaries
```

```{r 3.22-deprecated-packages}
deprecated_pkgs <- bbs_info |>
    dplyr::filter(PackageStatus == "Deprecated") |>
    dplyr::select(Package)

deprecated_pkgs
```

```{r sessionInfo}
sessionInfo()
```